<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>MV Transit</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            height: -webkit-fill-available;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: #000;
            color: #000;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: fixed;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        /* Main Search View */
        .search-view {
            height: 100vh;
            height: -webkit-fill-available;
            width: 100vw;
            display: flex;
            flex-direction: column;
            background: #f2f2f7;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            transition: transform 0.3s ease;
        }

        .search-view.hidden {
            transform: translateX(-100%);
        }

        .search-header {
            background: #fff;
            padding-top: env(safe-area-inset-top);
            padding-left: 16px;
            padding-right: 16px;
            padding-bottom: 16px;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
        }

        .app-title {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.4px;
            margin-bottom: 20px;
            margin-top: 12px;
        }

        .current-time {
            font-size: 17px;
            color: #8e8e93;
            font-weight: 400;
            float: right;
            margin-top: 12px;
        }

        .search-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .location-button {
            background: #ffffff;
            border: 1px solid #e5e5ea;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .location-button:active {
            background: #f2f2f7;
            transform: scale(0.98);
        }

        .location-button.active {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }

        .location-button.active svg {
            stroke: white;
        }

        .location-button svg {
            width: 22px;
            height: 22px;
            stroke: #007AFF;
            flex-shrink: 0;
        }

        .location-button span {
            font-size: 17px;
            font-weight: 500;
            letter-spacing: -0.4px;
        }

        .location-input {
            position: relative;
        }

        .location-select {
            width: 100%;
            padding: 16px 16px 16px 44px;
            background: #ffffff;
            border: 1px solid #e5e5ea;
            border-radius: 12px;
            color: #000;
            font-size: 17px;
            outline: none;
            transition: all 0.2s ease;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .location-select:focus {
            border-color: #007AFF;
        }

        .location-select option {
            background: #fff;
            color: #000;
            padding: 10px;
            font-size: 16px;
        }

        .location-select optgroup {
            background: #f2f2f7;
            color: #8e8e93;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .location-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
        }

        .route-btn {
            background: #007AFF;
            border: none;
            padding: 16px;
            border-radius: 12px;
            color: #fff;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 20px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: -0.4px;
        }

        .route-btn:active {
            transform: scale(0.98);
            background: #0051D5;
        }

        .route-btn:disabled {
            background: #c7c7cc;
            cursor: not-allowed;
        }

        /* Route View */
        .route-view {
            height: 100vh;
            height: -webkit-fill-available;
            width: 100vw;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
            background: #000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .route-view.active {
            transform: translateX(0);
        }

        #map {
            flex: 1;
            width: 100%;
            z-index: 1;
        }

        .route-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding-top: env(safe-area-inset-top);
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .route-header-content {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 12px;
        }

        .back-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            color: #007AFF;
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .back-btn svg {
            width: 24px;
            height: 24px;
        }

        .route-summary {
            flex: 1;
            text-align: center;
        }

        .route-summary-title {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.4px;
        }

        .route-summary-subtitle {
            font-size: 13px;
            color: #8e8e93;
            margin-top: 2px;
        }

        .route-details {
            position: absolute;
            bottom: env(safe-area-inset-bottom);
            left: 0;
            right: 0;
            background: #ffffff;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -3px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 40vh;
            transition: transform 0.3s ease;
        }

        .route-details-header {
            padding: 16px;
            border-bottom: 1px solid #e5e5ea;
            cursor: pointer;
        }

        .route-details-content {
            padding: 16px;
            overflow-y: auto;
            max-height: 30vh;
            -webkit-overflow-scrolling: touch;
        }

        .route-card {
            background: #f2f2f7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .bus-time-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .next-bus {
            font-size: 24px;
            font-weight: 700;
            color: #007AFF;
        }

        .duration {
            font-size: 15px;
            color: #8e8e93;
        }

        .route-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #e5e5ea;
        }

        .route-step:last-child {
            border-bottom: none;
        }

        .step-icon {
            width: 36px;
            height: 36px;
            background: #007AFF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
            color: white;
        }

        .step-icon.walk {
            background: #8e8e93;
            font-size: 16px;
        }

        .step-icon.transfer {
            background: #FF9500;
        }

        .step-info {
            flex: 1;
        }

        .step-name {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.4px;
        }

        .step-detail {
            font-size: 15px;
            color: #8e8e93;
            margin-top: 2px;
        }

        .bus-times {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .bus-time {
            background: #e5e5ea;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
        }

        .bus-time.next {
            background: #007AFF;
            color: white;
        }

        /* Custom map controls */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12) !important;
        }

        .leaflet-control-zoom a {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #007AFF !important;
            border: none !important;
            font-size: 20px !important;
            width: 36px !important;
            height: 36px !important;
            line-height: 36px !important;
        }

        .leaflet-routing-container {
            display: none !important;
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Search View -->
    <div class="search-view" id="search-view">
        <div class="search-header">
            <h1 class="app-title">
                Transit
                <span class="current-time" id="current-time"></span>
            </h1>
            
            <div class="search-container">
                <button class="location-button" id="location-button" onclick="requestUserLocation()">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <span id="location-text">Use Current Location</span>
                </button>
                
                <div class="location-input">
                    <svg class="location-icon" fill="none" stroke="#FF3B30" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 2a10 10 0 00-10 10c0 5.25 10 13 10 13s10-7.75 10-13a10 10 0 00-10-10z"></path>
                    </svg>
                    <select id="from-select" class="location-select">
                        <option value="">From</option>
                        <option value="current-location" style="display: none;">📍 Current Location</option>
                        <optgroup label="Vineyard Haven">
                            <option value="vh-ssa">Vineyard Haven SSA Terminal</option>
                            <option value="vh-downtown">Tisbury Downtown</option>
                            <option value="vh-parkride">Tisbury Park & Ride</option>
                        </optgroup>
                        <optgroup label="Oak Bluffs">
                            <option value="ob-ssa">Oak Bluffs SSA Terminal</option>
                            <option value="ob-ocean">Ocean Park</option>
                            <option value="ob-downtown">Oak Bluffs Downtown</option>
                        </optgroup>
                        <optgroup label="Edgartown">
                            <option value="edg-church">Church Street, Edgartown</option>
                            <option value="edg-downtown">Downtown Edgartown</option>
                            <option value="edg-southbeach">South Beach</option>
                        </optgroup>
                        <optgroup label="West Tisbury">
                            <option value="wt-townhall">West Tisbury Town Hall</option>
                            <option value="wt-grange">Grange Hall</option>
                            <option value="wt-business">West Tisbury Business District</option>
                        </optgroup>
                        <optgroup label="Chilmark">
                            <option value="ch-center">Chilmark Community Center</option>
                            <option value="ch-menemsha">Menemsha Beach</option>
                        </optgroup>
                        <optgroup label="Aquinnah">
                            <option value="aq-cliffs">Gay Head Lighthouse</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="airport">Martha's Vineyard Airport</option>
                            <option value="hospital">Martha's Vineyard Hospital</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="location-input">
                    <svg class="location-icon" fill="none" stroke="#34C759" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 2a10 10 0 00-10 10c0 5.25 10 13 10 13s10-7.75 10-13a10 10 0 00-10-10z"></path>
                    </svg>
                    <select id="to-select" class="location-select">
                        <option value="">To</option>
                        <optgroup label="Vineyard Haven">
                            <option value="vh-ssa">Vineyard Haven SSA Terminal</option>
                            <option value="vh-downtown">Tisbury Downtown</option>
                            <option value="vh-parkride">Tisbury Park & Ride</option>
                        </optgroup>
                        <optgroup label="Oak Bluffs">
                            <option value="ob-ssa">Oak Bluffs SSA Terminal</option>
                            <option value="ob-ocean">Ocean Park</option>
                            <option value="ob-downtown">Oak Bluffs Downtown</option>
                        </optgroup>
                        <optgroup label="Edgartown">
                            <option value="edg-church">Church Street, Edgartown</option>
                            <option value="edg-downtown">Downtown Edgartown</option>
                            <option value="edg-southbeach">South Beach</option>
                        </optgroup>
                        <optgroup label="West Tisbury">
                            <option value="wt-townhall">West Tisbury Town Hall</option>
                            <option value="wt-grange">Grange Hall</option>
                            <option value="wt-business">West Tisbury Business District</option>
                        </optgroup>
                        <optgroup label="Chilmark">
                            <option value="ch-center">Chilmark Community Center</option>
                            <option value="ch-menemsha">Menemsha Beach</option>
                        </optgroup>
                        <optgroup label="Aquinnah">
                            <option value="aq-cliffs">Gay Head Lighthouse</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="airport">Martha's Vineyard Airport</option>
                            <option value="hospital">Martha's Vineyard Hospital</option>
                        </optgroup>
                    </select>
                </div>
                
                <button class="route-btn" onclick="showRoute()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    Route
                </button>
            </div>
        </div>
    </div>

    <!-- Route View -->
    <div class="route-view" id="route-view">
        <div id="map"></div>
        
        <div class="route-header">
            <div class="route-header-content">
                <button class="back-btn" onclick="backToSearch()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Search
                </button>
                <div class="route-summary">
                    <div class="route-summary-title" id="route-title">Route</div>
                    <div class="route-summary-subtitle" id="route-subtitle"></div>
                </div>
                <div style="width: 80px;"></div>
            </div>
        </div>
        
        <div class="route-details">
            <div class="route-details-header" onclick="toggleDetails()">
                <div id="route-details-summary"></div>
            </div>
            <div class="route-details-content" id="route-details-content">
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map = null;
        let fromPin = null;
        let toPin = null;
        let routeControl = null;
        let walkingRouteControl = null;
        let userLocationMarker = null;
        let userLocation = null;
        let currentRoute = null;

        // Initialize time display
        function updateTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            document.getElementById('current-time').textContent = `${displayHours}:${minutes} ${ampm}`;
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Location data
        const locations = {
            'vh-ssa': { name: 'Vineyard Haven SSA Terminal', coords: [41.4547, -70.6055] },
            'vh-downtown': { name: 'Tisbury Downtown', coords: [41.4561, -70.6089] },
            'vh-parkride': { name: 'Tisbury Park & Ride', coords: [41.4534, -70.6001] },
            'ob-ssa': { name: 'Oak Bluffs SSA Terminal', coords: [41.4575, -70.5567] },
            'ob-ocean': { name: 'Ocean Park', coords: [41.4521, -70.5594] },
            'ob-downtown': { name: 'Oak Bluffs Downtown', coords: [41.4541, -70.5578] },
            'edg-church': { name: 'Church Street, Edgartown', coords: [41.3891, -70.5128] },
            'edg-downtown': { name: 'Downtown Edgartown', coords: [41.3889, -70.5153] },
            'edg-southbeach': { name: 'South Beach', coords: [41.3541, -70.5203] },
            'wt-townhall': { name: 'West Tisbury Town Hall', coords: [41.3792, -70.6731] },
            'wt-grange': { name: 'Grange Hall', coords: [41.3756, -70.6753] },
            'wt-business': { name: 'West Tisbury Business District', coords: [41.3806, -70.6714] },
            'ch-center': { name: 'Chilmark Community Center', coords: [41.3478, -70.7419] },
            'ch-menemsha': { name: 'Menemsha Beach', coords: [41.3461, -70.7678] },
            'aq-cliffs': { name: 'Gay Head Lighthouse', coords: [41.3486, -70.8347] },
            'airport': { name: 'Martha\'s Vineyard Airport', coords: [41.3931, -70.6143] },
            'hospital': { name: 'Martha\'s Vineyard Hospital', coords: [41.4419, -70.5869] }
        };

        // Routes data
        const routes = {
            '1': { name: 'Edgartown - Vineyard Haven', stops: ['edg-church', 'edg-downtown', 'airport', 'ob-downtown', 'vh-downtown', 'vh-ssa'], color: '#007AFF', frequency: 20, firstBus: '6:30', lastBus: '23:10' },
            '2': { name: 'West Tisbury - VH via Lambert\'s Cove', stops: ['wt-townhall', 'wt-business', 'vh-downtown', 'vh-ssa'], color: '#FF9500', frequency: 90, firstBus: '7:22', lastBus: '19:28' },
            '3': { name: 'West Tisbury - VH via State Road', stops: ['wt-townhall', 'wt-business', 'vh-downtown', 'vh-ssa'], color: '#34C759', frequency: 60, firstBus: '6:07', lastBus: '21:07' },
            '4': { name: 'West Tisbury - Chilmark - Menemsha', stops: ['wt-townhall', 'wt-business', 'ch-center', 'ch-menemsha'], color: '#FF3B30', frequency: 60, firstBus: '7:40', lastBus: '21:01' },
            '5': { name: 'West Tisbury - Chilmark - Aquinnah', stops: ['wt-townhall', 'wt-grange', 'ch-center', 'aq-cliffs'], color: '#AF52DE', frequency: 60, firstBus: '6:38', lastBus: '23:10' },
            '6': { name: 'Edgartown - Airport - West Tisbury', stops: ['edg-church', 'edg-downtown', 'airport', 'wt-grange', 'wt-townhall'], color: '#5AC8FA', frequency: 60, firstBus: '7:12', lastBus: '22:12' },
            '7': { name: 'Oak Bluffs - Airport - Hospital', stops: ['ob-ocean', 'ob-downtown', 'hospital', 'airport'], color: '#5856D6', frequency: 60, firstBus: '6:55', lastBus: '18:55' },
            '8': { name: 'South Beach', stops: ['edg-church', 'edg-downtown', 'edg-southbeach'], color: '#FFCC00', frequency: 30, firstBus: '6:45', lastBus: '20:09' },
            '9': { name: 'Oak Bluffs - Hospital - Airport', stops: ['ob-ocean', 'ob-downtown', 'hospital', 'airport'], color: '#8E8E93', frequency: 60, firstBus: '7:00', lastBus: '23:00' },
            '13': { name: 'Beach Road', stops: ['edg-church', 'edg-downtown', 'ob-ocean', 'ob-downtown', 'ob-ssa', 'vh-downtown', 'vh-ssa'], color: '#FF6482', frequency: 15, firstBus: '5:25', lastBus: '01:10' }
        };

        // Initialize map (only when route view is shown)
        function initializeMap() {
            if (map) return;
            
            map = L.map('map', {
                center: [41.4, -70.6],
                zoom: 11,
                zoomControl: false,
                tap: false,
                touchZoom: true,
                dragging: true,
                doubleClickZoom: true
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap contributors © CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);
        }

        // Custom icons
        const redIcon = L.divIcon({
            html: '<div style="background: #FF3B30; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            className: 'custom-pin'
        });

        const greenIcon = L.divIcon({
            html: '<div style="background: #34C759; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            className: 'custom-pin'
        });

        const blueIcon = L.divIcon({
            html: `<div style="position: relative; width: 30px; height: 30px;">
                <div style="background: #007AFF; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                <div style="background: rgba(0, 122, 255, 0.15); width: 30px; height: 30px; border-radius: 50%; position: absolute; top: 0; left: 0; animation: pulse 2s infinite;"></div>
            </div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            className: 'user-location-pin'
        });

        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Find nearest stop
        function findNearestStop(userLat, userLng) {
            let nearestStop = null;
            let shortestDistance = Infinity;
            
            Object.entries(locations).forEach(([id, loc]) => {
                const distance = calculateDistance(userLat, userLng, loc.coords[0], loc.coords[1]);
                if (distance < shortestDistance) {
                    shortestDistance = distance;
                    nearestStop = { id, ...loc, distance };
                }
            });
            
            return nearestStop;
        }

        // Request user location
        function requestUserLocation() {
            const button = document.getElementById('location-button');
            const buttonText = document.getElementById('location-text');
            
            if ("geolocation" in navigator) {
                button.classList.add('active');
                buttonText.textContent = 'Getting location...';
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        const nearestStop = findNearestStop(userLocation.lat, userLocation.lng);
                        const walkTime = Math.ceil(nearestStop.distance / 0.05);
                        
                        buttonText.textContent = `📍 ${walkTime} min walk to ${nearestStop.name}`;
                        
                        const fromSelect = document.getElementById('from-select');
                        const currentOption = fromSelect.querySelector('option[value="current-location"]');
                        currentOption.style.display = 'block';
                        currentOption.textContent = `📍 Current Location (${walkTime} min to ${nearestStop.name})`;
                        fromSelect.value = 'current-location';
                        
                        userLocation.nearestStop = nearestStop;
                        userLocation.walkTime = walkTime;
                    },
                    (error) => {
                        button.classList.remove('active');
                        buttonText.textContent = 'Use Current Location';
                        alert("Location access denied. Please enable location services.");
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                alert("Your browser doesn't support geolocation.");
            }
        }

        // Show route view
        function showRoute() {
            const fromId = document.getElementById('from-select').value;
            const toId = document.getElementById('to-select').value;
            
            if (!fromId || !toId) {
                alert('Please select both starting point and destination');
                return;
            }

            if (fromId === toId) {
                alert("You're already at your destination");
                return;
            }

            // Initialize map if needed
            initializeMap();

            // Switch views
            document.getElementById('search-view').classList.add('hidden');
            document.getElementById('route-view').classList.add('active');

            // Calculate and display route
            setTimeout(() => {
                findAndDisplayRoute(fromId, toId);
            }, 350);
        }

        // Back to search
        function backToSearch() {
            document.getElementById('route-view').classList.remove('active');
            document.getElementById('search-view').classList.remove('hidden');
            
            // Clear route
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }
            if (walkingRouteControl) {
                map.removeControl(walkingRouteControl);
                walkingRouteControl = null;
            }
        }

        // Find and display route
        function findAndDisplayRoute(fromId, toId) {
            let actualFromId = fromId;
            let includeWalking = false;
            
            if (fromId === 'current-location' && userLocation) {
                actualFromId = userLocation.nearestStop.id;
                includeWalking = true;
                
                // Add user location marker
                if (userLocationMarker) map.removeLayer(userLocationMarker);
                userLocationMarker = L.marker([userLocation.lat, userLocation.lng], { icon: blueIcon }).addTo(map);
            }

            // Add destination pin
            const toLoc = locations[toId];
            if (toPin) map.removeLayer(toPin);
            toPin = L.marker(toLoc.coords, { icon: greenIcon }).addTo(map);

            // Find route
            const possibleRoutes = findPossibleRoutes(actualFromId, toId, includeWalking);
            
            if (possibleRoutes.length > 0) {
                currentRoute = possibleRoutes[0];
                displayRoute(currentRoute);
                
                // Draw on map
                if (includeWalking && userLocation) {
                    drawWalkingRoute(userLocation, locations[actualFromId].coords);
                }
                drawBusRoute(currentRoute);
                
                // Update header
                document.getElementById('route-title').textContent = `${currentRoute.duration} min`;
                document.getElementById('route-subtitle').textContent = currentRoute.type === 'direct' ? 'Direct' : 'Transfer required';
            }
        }

        // Get next bus times
        function getNextBusTimes(route, fromStop, toStop, walkingBuffer = 0) {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes() + 3 + walkingBuffer;
            
            const buses = [];
            const [startHour, startMin] = route.firstBus.split(':').map(Number);
            const [endHour, endMin] = route.lastBus.split(':').map(Number);
            const startMinutes = startHour * 60 + startMin;
            const endMinutes = endHour * 60 + endMin;
            
            for (let time = startMinutes; time <= endMinutes; time += route.frequency) {
                const hour = Math.floor(time / 60);
                const min = time % 60;
                const displayHour = hour % 12 || 12;
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const timeStr = `${displayHour}:${min.toString().padStart(2, '0')} ${ampm}`;
                
                buses.push({
                    time: timeStr,
                    minutes: time,
                    isMissed: time < currentMinutes,
                    isNext: time >= currentMinutes && buses.filter(b => !b.isMissed).length === 0
                });
            }
            
            return buses;
        }

        // Find possible routes
        function findPossibleRoutes(from, to, includeWalking = false) {
            const possibleRoutes = [];
            const walkingBuffer = includeWalking && userLocation ? userLocation.walkTime : 0;

            for (const [routeNum, route] of Object.entries(routes)) {
                if (route.stops.includes(from) && route.stops.includes(to)) {
                    const fromIndex = route.stops.indexOf(from);
                    const toIndex = route.stops.indexOf(to);
                    
                    if (fromIndex < toIndex) {
                        const duration = (toIndex - fromIndex) * 5 + 10;
                        const buses = getNextBusTimes(route, from, to, walkingBuffer);
                        const nextBus = buses.find(b => !b.isMissed);
                        
                        possibleRoutes.push({
                            type: 'direct',
                            duration: duration + walkingBuffer,
                            nextBus: nextBus,
                            buses: buses.slice(0, 5),
                            includeWalking: includeWalking,
                            walkTime: walkingBuffer,
                            steps: [{
                                route: routeNum,
                                from: from,
                                to: to,
                                name: route.name,
                                color: route.color,
                                description: `Route ${routeNum}`,
                                departureTime: nextBus ? nextBus.time : null
                            }]
                        });
                    }
                }
            }

            return possibleRoutes;
        }

        // Display route details
        function displayRoute(route) {
            const summaryEl = document.getElementById('route-details-summary');
            const contentEl = document.getElementById('route-details-content');
            
            // Summary
            summaryEl.innerHTML = `
                <div class="bus-time-header">
                    <div>
                        <div class="next-bus">${route.nextBus ? route.nextBus.time : 'No buses'}</div>
                        <div class="duration">Next departure</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 20px; font-weight: 600;">${route.duration} min</div>
                        <div class="duration">Total journey</div>
                    </div>
                </div>
            `;
            
            // Details
            let html = '';
            
            if (route.includeWalking && userLocation) {
                html += `
                    <div class="route-step">
                        <div class="step-icon walk">🚶</div>
                        <div class="step-info">
                            <div class="step-name">Walk to ${userLocation.nearestStop.name}</div>
                            <div class="step-detail">${route.walkTime} min • ${userLocation.nearestStop.distance.toFixed(2)} mi</div>
                        </div>
                    </div>
                `;
            }
            
            route.steps.forEach((step, index) => {
                html += `
                    <div class="route-step">
                        <div class="step-icon" style="background: ${step.color}">${index + 1}</div>
                        <div class="step-info">
                            <div class="step-name">Bus #${step.route} - ${step.name}</div>
                            <div class="step-detail">${locations[step.from].name} → ${locations[step.to].name}</div>
                        </div>
                    </div>
                `;
            });
            
            if (route.buses && route.buses.length > 0) {
                html += '<div class="bus-times">';
                route.buses.forEach(bus => {
                    html += `<div class="bus-time ${bus.isNext ? 'next' : ''}">${bus.time}</div>`;
                });
                html += '</div>';
            }
            
            contentEl.innerHTML = html;
        }

        // Draw walking route
        function drawWalkingRoute(from, to) {
            walkingRouteControl = L.Routing.control({
                waypoints: [
                    L.latLng(from.lat, from.lng),
                    L.latLng(to[0], to[1])
                ],
                routeWhileDragging: false,
                addWaypoints: false,
                createMarker: function() { return null; },
                lineOptions: {
                    styles: [{
                        color: '#007AFF',
                        weight: 4,
                        opacity: 0.6,
                        dashArray: '5, 10'
                    }]
                }
            }).addTo(map);
        }

        // Draw bus route
        function drawBusRoute(route) {
            const waypoints = [];
            
            waypoints.push(L.latLng(locations[route.steps[0].from].coords));
            
            route.steps.forEach(step => {
                if (step.transfer) {
                    waypoints.push(L.latLng(locations[step.from].coords));
                }
            });
            
            const lastStep = route.steps[route.steps.length - 1];
            waypoints.push(L.latLng(locations[lastStep.to].coords));

            routeControl = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                addWaypoints: false,
                createMarker: function() { return null; },
                lineOptions: {
                    styles: [{
                        color: '#007AFF',
                        weight: 5,
                        opacity: 0.8
                    }]
                }
            }).addTo(map);

            // Fit bounds
            setTimeout(() => {
                const bounds = [];
                if (userLocationMarker) bounds.push(userLocationMarker.getLatLng());
                waypoints.forEach(wp => bounds.push(wp));
                
                map.fitBounds(bounds, { 
                    paddingTopLeft: [20, 80],
                    paddingBottomRight: [20, 200]
                });
            }, 500);
        }

        // Toggle details panel
        function toggleDetails() {
            const details = document.querySelector('.route-details');
            const isExpanded = details.style.transform === 'translateY(-200px)';
            details.style.transform = isExpanded ? '' : 'translateY(-200px)';
        }
    </script>
</body>
</html>
